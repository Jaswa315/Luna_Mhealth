#Template to run flutter tests in provided folder (package_path)
#This template does not publish test results.
parameters:
- name: package_path
  default: ''
- name: package_name
  default: ''
- name: cur_cov_folder
  default: current_coverage
- name: include_coverage
  default: 'false'
- name: test_file_name # parameter to determine if a custom test file is run
  default: ''

steps:
- script: |
    cd ${{ parameters.package_path }}
    flutter pub get
  displayName: 'Get Flutter packages for the ${{ parameters.package_name }}'

- task: PowerShell@2
  displayName: 'Generate all test file for ${{ parameters.package_name }}'
  condition: ${{ ne(parameters.test_file_name, '') }} 
  inputs: 
    filePath: pipelines/scripts/generate_luna_test_files.ps1
    arguments: >
      -LunaFolder ${{  parameters.package_path  }}
      -OutputFile ${{  parameters.test_file_name  }}


- task: PowerShell@2
  condition: eq(${{ parameters.include_coverage }}, 'true')
  inputs:
    targetType: 'inline'
    script: |
      New-Item -ItemType Directory -Path ${{  parameters.cur_cov_folder  }} -ErrorAction SilentlyContinue
      cd ${{ parameters.package_path }}
      flutter test ${{  parameters.test_file_name  }} --machine --coverage | tojunit --output ../test-${{ parameters.package_name }}-results.xml
      cobertura convert --output ../${{ parameters.cur_cov_folder }}/coverage-${{ parameters.package_name }}.xml
  displayName: 'Run ${{ parameters.package_name }} tests with coverage'

- task: PowerShell@2
  condition: not(eq(${{ parameters.include_coverage }},'true'))
  inputs:
    targetType: 'inline'
    script: |
      cd ${{ parameters.package_path }}
      flutter test ${{  parameters.test_file_name  }} --machine | tojunit --output ../test-${{ parameters.package_name }}-results.xml
  displayName: 'Run ${{ parameters.package_name }} tests'
